<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEIN.NET // FINAL_FLAT_VER</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --primary: #00f3ff;
            --secondary: #0066ff;
            --danger: #ff2a2a;
            --window-bg: #0b0d12;
            --window-header: #141820;
            --border: rgba(0, 243, 255, 0.4);
            --text-main: #d0d5dd;
            
            /* åŠ¿åŠ›è‰² */
            --c-vespera: #d000ff;
            --c-babylon: #ffc800;
            --c-neo: #ffffff;
            --c-market: #00f3ff;
            --c-slums: #ff2a2a;
            --c-clinic: #00ff99;
            --c-noise: #0088ff;
        }

        * { box-sizing: border-box; user-select: none; }
        body {
            margin: 0; overflow: hidden;
            background: #000; color: var(--text-main);
            font-family: 'Noto Sans SC', sans-serif;
            height: 100vh; width: 100vw;
            display: flex; flex-direction: column;
        }

        /* === è§†è§‰ç‰¹æ•ˆå±‚ === */
        /* è°ƒä½äº†æ‰«æçº¿çš„å±‚çº§ï¼Œä¿è¯å®ƒä¸ä¼šæŒ¡ä½æ–‡å­—å¤ªä¸¥é‡ */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
        }
        .vignette {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 40;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.9);
        }

        /* Glitch æ–‡å­—ç‰¹æ•ˆ */
        .glitch { position: relative; display: inline-block; }
        .glitch::before, .glitch::after {
            content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0.8; clip: rect(0, 0, 0, 0);
        }
        .glitch::before { left: 2px; text-shadow: -1px 0 #ff00c1; animation: glitch-anim-1 2s infinite linear alternate-reverse; }
        .glitch::after { left: -2px; text-shadow: -1px 0 #00fff9; animation: glitch-anim-2 3s infinite linear alternate-reverse; }
        @keyframes glitch-anim-1 {
            0% { clip: rect(20px, 9999px, 15px, 0); } 20% { clip: rect(50px, 9999px, 60px, 0); }
            40% { clip: rect(10px, 9999px, 80px, 0); } 60% { clip: rect(80px, 9999px, 20px, 0); }
            80% { clip: rect(30px, 9999px, 40px, 0); } 100% { clip: rect(60px, 9999px, 5px, 0); }
        }
        @keyframes glitch-anim-2 {
            0% { clip: rect(60px, 9999px, 5px, 0); } 20% { clip: rect(10px, 9999px, 80px, 0); }
            40% { clip: rect(30px, 9999px, 40px, 0); } 60% { clip: rect(50px, 9999px, 60px, 0); }
            80% { clip: rect(20px, 9999px, 15px, 0); } 100% { clip: rect(80px, 9999px, 20px, 0); }
        }
        .redacted { background: #000; color: #000; padding: 0 4px; cursor: help; transition: color 0.3s; }
        .redacted:hover { color: #333; }

        /* === å¯åŠ¨ä¸é€€å‡ºç•Œé¢ === */
        #intro-screen, #outro-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 20000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Orbitron'; color: var(--primary);
        }
        #outro-screen { display: none; z-index: 20001; }

        .big-text { font-size: 2rem; margin-bottom: 20px; text-align: center; letter-spacing: 2px; }
        .sub-text { font-family: 'Share Tech Mono'; font-size: 1rem; color: #666; letter-spacing: 1px; }
        
        .loader-bar {
            width: 300px; height: 4px; background: #222; margin-top: 40px; position: relative; overflow: hidden;
        }
        .loader-progress {
            position: absolute; left: 0; top: 0; height: 100%; width: 0%; background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
            transition: width 0.1s linear;
        }

        /* CRT å…³æœºåŠ¨ç”» */
        @keyframes turn-off {
            0% { transform: scale(1, 1.3) translate3d(0, 0, 0); filter: brightness(1); opacity: 1; }
            60% { transform: scale(1, 0.001) translate3d(0, 0, 0); filter: brightness(10); }
            100% { animation-timing-function: cubic-bezier(0.755, 0.05, 0.855, 0.06); transform: scale(0, 0.0001) translate3d(0, 0, 0); filter: brightness(50); opacity: 0; }
        }
        .crt-off { animation: turn-off 0.55s cubic-bezier(0.23, 1, 0.32, 1); animation-fill-mode: forwards; }

        /* === ä¸»ç•Œé¢å®¹å™¨ === */
        #main-interface {
            display: none;
            flex: 1; flex-direction: column; height: 100%; overflow: hidden;
        }

        /* === å¸ƒå±€ç»†èŠ‚ === */
        #top-hud {
            height: 40px; background: #080a0c; border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
            font-family: 'Share Tech Mono'; font-size: 0.8rem; z-index: 2000; color: var(--primary);
            flex-shrink: 0;
        }
        .power-btn {
            font-size: 1.2rem; color: var(--danger); cursor: pointer; 
            border: 1px solid #333; width: 30px; height: 30px; display: grid; place-items: center;
            transition: 0.2s;
        }
        .power-btn:hover { background: var(--danger); color: #000; box-shadow: 0 0 10px var(--danger); }

        .ticker-wrap {
            flex: 1; overflow: hidden; height: 100%; margin: 0 30px; position: relative;
            background: rgba(0, 243, 255, 0.05); border-left: 1px solid #333; border-right: 1px solid #333;
            display: flex; align-items: center;
        }
        .ticker-move { display: inline-block; white-space: nowrap; animation: ticker 40s linear infinite; color: #889; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        #workspace { flex: 1; position: relative; display: flex; overflow: hidden; }

        .sidebar-matrix {
            width: 250px; height: 100%; background: #000; 
            border-right: 1px solid #222; position: relative; z-index: 1; flex-shrink: 0;
            overflow: hidden; 
        }
        .sidebar-right { border-right: none; border-left: 1px solid #222; }
        
        /* å¼ºåˆ¶ Canvas å¡«æ»¡ä¾§è¾¹æ  */
        canvas { display: block; width: 100%; height: 100%; }

        /* æ‰‹æœºç«¯éšè—ä¾§è¾¹æ ï¼Œä½†å…è®¸å¹³æ¿æ˜¾ç¤º */
        @media (max-width: 600px) { .sidebar-matrix { display: none; } }

        #map-container {
            flex: 1; position: relative; overflow: hidden;
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(0, 60, 100, 0.15), transparent 85%),
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 100% 100%, 60px 60px, 60px 60px;
            background-color: #050505;
        }

        .pin {
            position: absolute; display: flex; flex-direction: column; align-items: center;
            cursor: pointer; z-index: 10; transition: 0.2s;
        }
        .pin:hover { z-index: 20; transform: scale(1.1); filter: drop-shadow(0 0 15px var(--c)); }
        .pin-icon {
            width: 48px; height: 48px; background: rgba(0,0,0,0.85);
            border: 2px solid var(--c); color: var(--c);
            display: grid; place-items: center; font-size: 1.5rem;
            box-shadow: 0 0 10px rgba(0,0,0,0.5); border-radius: 4px;
        }
        .pin-label {
            margin-top: 5px; background: #000; color: #fff;
            padding: 2px 8px; font-size: 0.7rem; border: 1px solid var(--c);
            white-space: nowrap; font-family: 'Share Tech Mono'; letter-spacing: 1px;
        }

        /* çª—å£ç›¸å…³ */
        .window {
            position: absolute; background: var(--window-bg);
            border: 1px solid var(--border);
            box-shadow: 0 20px 80px rgba(0,0,0,0.95);
            display: flex; flex-direction: column;
            overflow: hidden; min-width: 300px;
            animation: openWin 0.2s cubic-bezier(0.19, 1, 0.22, 1);
        }
        @keyframes openWin { from { opacity:0; transform: scale(0.95); } to { opacity:1; transform: scale(1); } }
        .win-header {
            height: 36px; background: var(--window-header); border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 10px; cursor: move; flex-shrink: 0;
        }
        .win-title { font-family: 'Orbitron'; font-size: 0.85rem; color: #fff; display: flex; align-items: center; gap: 10px; }
        .close-btn {
            background: transparent; border: 1px solid var(--danger); color: var(--danger);
            width: 24px; height: 24px; line-height: 22px; text-align: center;
            cursor: pointer; font-family: sans-serif; font-weight: bold;
        }
        .close-btn:hover { background: var(--danger); color: #000; }
        .win-body { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .shop-window .win-body { overflow: hidden; }

        /* å•†åº—ä¸è¯¦æƒ… */
        .shop-container { display: flex; height: 100%; }
        .shop-sidebar { width: 240px; background: rgba(0,0,0,0.4); border-right: 1px solid #333; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; }
        .shop-meta-block { margin-bottom: 20px; font-size: 0.85rem; color: #999; line-height: 1.6; }
        .npc-mini-card {
            background: rgba(255,255,255,0.03); border: 1px solid #444; padding: 10px; margin-top: 10px; 
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .npc-mini-card:hover { border-color: var(--primary); background: rgba(0,243,255,0.05); }
        .npc-mini-avatar { width: 30px; height: 30px; background:#000; border-radius: 50%; overflow: hidden; border: 1px solid #555; }
        .npc-mini-avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .shop-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .menu-header { padding: 10px 20px; border-bottom: 1px solid #333; font-family: 'Share Tech Mono'; color: var(--primary); font-size: 0.9rem; background: rgba(0,243,255,0.02); flex-shrink: 0; }
        .goods-grid { flex: 1; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; align-content: start; }
        
        .item-card {
            background: rgba(0,0,0,0.4); border: 1px solid #333; padding: 10px; 
            cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; gap: 8px; position: relative;
        }
        .item-card:hover { border-color: #fff; background: #1a1c25; }
        .item-icon { height: 80px; background: #000; border: 1px solid #222; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #555; }
        .item-name { font-weight: bold; font-size: 0.9rem; color: #eee; }
        .item-price { font-family: 'Share Tech Mono'; color: var(--primary); font-size: 0.8rem; text-align: right; }
        .item-stock { position: absolute; top: 5px; left: 5px; font-size: 0.6rem; background: #222; padding: 2px 4px; color: #aaa; border-radius: 2px; }

        .item-detail-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 200px;
            background: rgba(10, 15, 20, 0.98); border-top: 2px solid var(--primary);
            padding: 20px; display: flex; gap: 20px; transform: translateY(100%); transition: transform 0.3s ease; z-index: 50;
        }
        .item-detail-overlay.active { transform: translateY(0); }
        .detail-img { width: 100px; height: 100px; background: #000; border: 1px solid #444; flex-shrink: 0; display: grid; place-items: center; font-size: 2rem; }
        .detail-info { flex: 1; overflow-y: auto; }

        .zone-banner { padding: 25px; background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent); border-bottom: 1px solid #333; }
        .zone-desc { font-size: 0.95rem; color: #bbb; line-height: 1.8; text-align: justify; }
        .entry-item {
            display: flex; align-items: center; gap: 15px; padding: 15px 20px; border-bottom: 1px solid #222; 
            cursor: pointer; transition: 0.2s; flex-shrink: 0;
        }
        .entry-item:hover { background: rgba(255,255,255,0.05); padding-left: 25px; }
        .ei-icon { font-size: 1.5rem; width: 40px; text-align: center; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; border: 1px solid #000; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div class="vignette"></div>

    <div id="intro-screen">
        <div class="big-text" id="welcome-text"></div>
        <div class="sub-text" id="sub-welcome"></div>
        <div class="loader-bar">
            <div class="loader-progress" id="loader"></div>
        </div>
        <div style="margin-top:10px; font-family:'Share Tech Mono'; font-size:0.7rem; color:#444;">INITIALIZING NEURO-LINK...</div>
    </div>

    <div id="outro-screen">
        <div class="big-text" style="color:var(--danger)">SYSTEM SHUTDOWN</div>
        <div class="sub-text">æ„Ÿè°¢æ‚¨çš„ä½¿ç”¨</div>
        <div class="sub-text" style="margin-top:5px; font-size:0.8rem;">THANK YOU FOR USING SEIN.NET</div>
    </div>

    <div id="main-interface">
        <div id="top-hud">
            <div style="display:flex; gap:20px; align-items:center;">
                <span style="font-weight:900; font-size:1.1rem; color:#fff;" class="glitch" data-text="SEIN.NET">SEIN.NET</span>
                <span style="font-size:0.7rem; color:#666;">SYS_VER: 5.2.0 (MATRIX_OK)</span>
                <span>NET: <span style="color:#0f0">SECURE</span></span>
            </div>
            <div class="ticker-wrap">
                <div class="ticker-move">
                    /// ALERT: Neo Execution Squad declares Sector-4 a 'No-Go Zone' /// MARKET: Vespera stocks up 4.2% after 'successful cleanup' /// WEATHER: Heavy Acid Rain expected in Zone-1 /// WARNING: Unregistered Cyberdecks will be confiscated ///
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:20px;">
                <div id="clock" style="color:#fff; font-weight:bold;">00:00:00</div>
                <div class="power-btn" onclick="shutdownSystem()" title="SHUTDOWN">â»</div>
            </div>
        </div>

        <div id="workspace">
            <div class="sidebar-matrix"><canvas id="canvas-left"></canvas></div>

            <div id="map-container">
                <div class="pin" style="top:20%; left:45%; --c:var(--c-vespera)" onclick="spawnZone('vespera')">
                    <div class="pin-icon">â–</div><div class="pin-label">ç»´æ–¯ä½©æ‹‰</div>
                </div>
                <div class="pin" style="top:50%; left:50%; --c:var(--c-babylon)" onclick="spawnZone('babylon')">
                    <div class="pin-icon">ğŸ­</div><div class="pin-label">å·´æ¯”ä¼¦å‰§é™¢</div>
                </div>
                <div class="pin" style="top:40%; right:20%; --c:var(--c-market)" onclick="spawnZone('market')">
                    <div class="pin-icon">ğŸ›’</div><div class="pin-label">Z-1 å•†ä¸šè¡—</div>
                </div>
                <div class="pin" style="top:25%; left:25%; --c:var(--c-neo)" onclick="spawnZone('neo')">
                    <div class="pin-icon">âš–ï¸</div><div class="pin-label">Neo æ‰§è¡Œé˜Ÿ</div>
                </div>
                <div class="pin" style="bottom:25%; left:25%; --c:var(--c-slums)" onclick="spawnZone('slums')">
                    <div class="pin-icon">ğŸšï¸</div><div class="pin-label">å•†è´¸è´«æ°‘çªŸ</div>
                </div>
                <div class="pin" style="bottom:40%; right:15%; --c:var(--c-clinic)" onclick="spawnShop('clinic')">
                    <div class="pin-icon">âœš</div><div class="pin-label">åå··è¯Šæ‰€</div>
                </div>
                <div class="pin" style="top:10%; right:35%; --c:var(--c-noise)" onclick="spawnShop('power_plant')">
                    <div class="pin-icon">âš¡</div><div class="pin-label">B-04 å˜ç”µç«™</div>
                </div>
                <div class="pin" style="bottom:15%; right:45%; --c:var(--c-noise)" onclick="spawnShop('water_plant')">
                    <div class="pin-icon">ğŸ’§</div><div class="pin-label">å‡€æ°´å‚</div>
                </div>
                <div class="pin" style="top:60%; left:10%; --c:var(--c-noise)" onclick="spawnShop('metro_station')">
                    <div class="pin-icon">ğŸš‡</div><div class="pin-label">æ—§åœ°é“ç«™</div>
                </div>
            </div>

            <div class="sidebar-matrix sidebar-right"><canvas id="canvas-right"></canvas></div>
        </div>
    </div>

    <script>
        // ================== ç³»ç»Ÿé€»è¾‘ï¼šå¯åŠ¨ä¸é€€å‡º ==================
        window.onload = function() {
            // ç«‹å³å¯åŠ¨ä»£ç é›¨
            startRain();

            const txt1 = "æ¬¢è¿ä½¿ç”¨å¡æ©å¸‚ä¿¡æ¯ç»ˆç«¯";
            const txt2 = "WELCOME TO SEIN CITY INFO TERMINAL";
            const el1 = document.getElementById('welcome-text');
            const el2 = document.getElementById('sub-welcome');
            const loader = document.getElementById('loader');
            const intro = document.getElementById('intro-screen');
            const main = document.getElementById('main-interface');

            let i = 0;
            function typeWriter1() {
                if (i < txt1.length) {
                    el1.innerHTML += txt1.charAt(i);
                    i++;
                    setTimeout(typeWriter1, 50);
                } else {
                    i = 0;
                    typeWriter2();
                }
            }
            function typeWriter2() {
                if (i < txt2.length) {
                    el2.innerHTML += txt2.charAt(i);
                    i++;
                    setTimeout(typeWriter2, 20);
                } else {
                    startLoading();
                }
            }
            function startLoading() {
                loader.style.width = "100%";
                setTimeout(() => {
                    intro.style.opacity = 0;
                    setTimeout(() => {
                        intro.style.display = 'none';
                        main.style.display = 'flex';
                        // ä¸»ç•Œé¢æ˜¾ç¤ºåï¼Œå¼ºåˆ¶å†åˆ·æ–°ä¸€æ¬¡ä»£ç é›¨ï¼Œç¡®ä¿ä½ç½®æ­£ç¡®
                        startRain();
                    }, 500);
                }, 800);
            }
            typeWriter1();
        };

        function shutdownSystem() {
            const main = document.getElementById('main-interface');
            const outro = document.getElementById('outro-screen');
            main.classList.add('crt-off');
            setTimeout(() => {
                main.style.display = 'none';
                outro.style.display = 'flex';
            }, 500);
        }

        // ================== æ•°æ®åº“ (æ‰å¹³åŒ–è·¯å¾„ï¼šç›´æ¥ç”¨æ–‡ä»¶å) ==================
        const db = {
            market: {
                title: "Z-1 å•†ä¸šè¡—", type: "ZONE", color: "#00f3ff",
                desc: `
                    ä½ç½®ï¼šä¸­å±‚åŒº Â· ç¼“å†²åŒºã€‚<br><br>
                    è¿™é‡Œæ˜¯å¡æ©å¸‚æœ€ç¹åçš„éœ“è™¹è¡—åŒºï¼Œä¹Ÿæ˜¯å„ç§æ€ªäººå¼€åº—çš„åœ°æ–¹ã€‚
                `,
                list: [
                    { id: 'leblanc', name: "å¢å¸ƒæœ—å’–å•¡", sub: "Cafe Leblanc", icon: "â˜•", type: "shop" },
                    { id: 'decade', name: "å…‰å½±å›å»Š", sub: "Decade Photo", icon: "ğŸ“·", type: "shop" },
                    { id: 'kirei', name: "ä¸­åæ–™ç†Â·è¨€å³°", sub: "Kirei's Kitchen", icon: "ğŸŒ¶ï¸", type: "shop" },
                    { id: 'stranger', name: "é™Œç”Ÿäººå†›ç«é“º", sub: "Stranger's Armory", icon: "ğŸ”«", type: "shop" }
                ]
            },
            leblanc: {
                title: "å¢å¸ƒæœ—å’–å•¡", color: "#d05e00",
                address: "Z-1åŒº, åå·· 4-02", hours: "18:00 - 04:00 (æ·±å¤œè¥ä¸š)",
                intro: "ä¸€å®¶å……æ»¡å¤å¤æ˜­å’Œæ°”æ¯çš„é˜æ¥¼å’–å•¡é¦†ã€‚",
                npcs: [{ id: 'sojiro', name: "ä½ä»“", role: "åº—ä¸»", img: "ä½ä»“.jpg" }],
                menu: [
                    { id: 'coffee', name: "å¤§å¸ˆæ‰‹å†²å’–å•¡", price: "500 CR", icon: "â˜•", type: "æ¶ˆè€—å“", desc: "é€‰ç”¨ç¨€æœ‰çš„æ·±çƒ˜è±†ã€‚<br><b>ã€æ•ˆæœã€‘</b> æ¢å¤ 1d6 ç²¾ç¥å€¼ (SAN)ã€‚" },
                    { id: 'curry', name: "å¢å¸ƒæœ—æ¿€è¾£å’–å–±", price: "800 CR", icon: "ğŸ›", type: "é£Ÿç‰©", desc: "åŠ å…¥äº†ä¸æ˜ç§˜åˆ¶é¦™æ–™ã€‚<br><b>ã€æ•ˆæœã€‘</b> æ¢å¤ 1d8 ä½“åŠ›å€¼ (HP)ã€‚" },
                    { id: 'hideout', name: "é˜æ¥¼é¿éš¾æƒ", price: "5,000 CR/å‘¨", icon: "ğŸ ", type: "æœåŠ¡", desc: "ç§Ÿç”¨äºŒæ¥¼é˜æ¥¼ä¸€å‘¨ã€‚<br><b>ã€ç‰¹æ®Šã€‘</b> æ­¤å¤„ä¸ºç»å¯¹å®‰å…¨å±‹ã€‚" }
                ]
            },
            decade: {
                title: "å…‰å½±å›å»Š", color: "#ff00ff",
                address: "Z-1åŒº, éœ“è™¹å¤§é“ 11å·", hours: "ä¸å®šæ—¶ (çœ‹å¿ƒæƒ…)",
                intro: "æŒ‚ç€å“çº¢è‰²éœ“è™¹æ‹›ç‰Œçš„å°åº—ã€‚",
                npcs: [{ id: 'kadoya', name: "é—¨çŸ¢", role: "æ‘„å½±å¸ˆ", img: "é—¨çŸ¢.jpg" }],
                menu: [
                    { id: 'id_card', name: "å®Œç¾ä¼ªé€ ID", price: "10,000 CR", icon: "ğŸ’³", type: "è¿ç¦å“", desc: "æŠ€æœ¯ä¸€æµï¼Œè¿Neoæ‰§è¡Œé˜Ÿéƒ½æŸ¥ä¸å‡ºæ¥çš„å®Œç¾ä¼ªé€ ã€‚" },
                    { id: 'camera_color', name: "å“çº¢ç›¸æœº", price: "éå–å“", icon: "ğŸ“·", type: "ç¥å™¨", desc: "<b>ã€è­¦å‘Šã€‘</b> ç»å¯¹ä¸è¦è¯´å®ƒæ˜¯ç²‰è‰²çš„ï¼ä»–ä¼šç”Ÿæ°”çº æ­£é‚£æ˜¯â€œå“çº¢â€ï¼" }
                ]
            },
            kirei: {
                title: "ä¸­åæ–™ç†Â·è¨€å³°", color: "#ff2a2a",
                address: "Z-1åŒº, åœ°ä¸‹ç¾é£Ÿè¡— B2", hours: "24h è¥ä¸š",
                intro: "è¿˜æ²¡è¿›é—¨å°±èƒ½é—»åˆ°è‡´æ­»é‡çš„è¾£æ¤’å‘³ã€‚",
                npcs: [{ id: 'kirei_npc', name: "è¨€å³°ç¥çˆ¶", role: "åº—ä¸»", img: "è¨€å³°.jpg" }],
                menu: [
                    { id: 'mapo', name: "æè¾£éº»å©†è±†è…", price: "666 CR", icon: "ğŸŒ¶ï¸", type: "ç”ŸåŒ–æ­¦å™¨", desc: "çº¢å¾—å‘é»‘çš„è±†è…ã€‚<br><b>ã€æ•ˆæœã€‘</b> é£Ÿç”¨åéœ€è¿›è¡Œã€ä½“è´¨ã€‘æ£€å®šã€‚" },
                    { id: 'water', name: "æ•‘å‘½å†°æ°´", price: "1,000 CR", icon: "ğŸ’§", type: "åœ£æ°´?", desc: "ç¥çˆ¶æ­£åœ¨æ¶æ„æ¶¨ä»·ä¸­ã€‚" }
                ]
            },
            stranger: {
                title: "é™Œç”Ÿäººå†›ç«é“º", color: "#aa00ff",
                address: "æµåŠ¨ (å½“å‰: é»‘æš—å°å··)", hours: "Always Open",
                intro: "What are ya buyin? ä¸€ä¸ªç©¿ç€ç´«è‰²é£è¡£çš„é«˜å¤§å•†äººã€‚",
                npcs: [{ id: 'merchant', name: "å•†äºº", role: "å†›ç«å•†", img: "å•†äºº.jpg" }],
                menu: [
                    { id: 'pistol', name: "é»‘æ˜Ÿæ‰‹æª", price: "2,000 CR", icon: "ğŸ”«", type: "æ­¦å™¨", desc: "æ—§æ—¶ä»£è­¦ç”¨æ‰‹æªçš„ä»¿åˆ¶å“ã€‚" },
                    { id: 'rpg', name: "RPG-7", price: "15,000 CR", icon: "ğŸš€", type: "é‡æ­¦å™¨", desc: "è¿™ç©æ„å„¿ä»–æ˜¯ä»å“ªæå‡ºæ¥çš„ï¼Ÿ<br>é™„èµ ä¸€å‘é«˜çˆ†å¼¹å¤´ã€‚" }
                ]
            },
            vespera: {
                title: "ç»´æ–¯ä½©æ‹‰å®¶æ”¿", type: "CORP", color: "#d000ff",
                desc: `
                    æ€»éƒ¨ä½ç½®ï¼šä¸Šå±‚åŒº Â· ç¿¡ç¿ åº„å›­ã€‚<br><br>
                    è¡¨é¢ä¸Šï¼Œè¿™æ˜¯ä¸€å®¶å„æ–­äº†ä¸Šå±‚åŒº90%å¸‚åœºçš„åˆæ³•ä¼ä¸šã€‚å®é™…ä¸Šï¼Œè¿™æ˜¯ä¸€ä¸ªä»¥â€œæ¸…æ´â€ä¸ºéšå–»çš„ç²¾è‹±é›‡ä½£å…µå›¢ã€‚
                `,
                list: [
                    { id: 'seizan', name: "æ¾åŸ é’è¡«", sub: "å¹•åå®¶ä¸»", icon: "ğŸ‘¤", type: "char" },
                    { id: 'shen', name: "æ²ˆ å¢¨å…°", sub: "æ‰§è¡Œæ€»ç®¡", icon: "ğŸ‘¤", type: "char" }
                ]
            },
            babylon: {
                title: "å·´æ¯”ä¼¦å¤§å‰§é™¢", type: "CORP", color: "#ffc800",
                desc: `
                    ä½ç½®ï¼šä¸Šå±‚åŒº Â· é»„é‡‘å¤§é“ 01 å·ã€‚<br><br>
                    å¡æ©å¸‚æœ€å¥¢åçš„å»ºç­‘ï¼Œä¹Ÿæ˜¯æƒè´µä»¬å”¯ä¸€çš„ç²¾ç¥é¿éš¾æ‰€ã€‚
                `,
                list: [
                    { id: 'edward', name: "çˆ±å¾·å", sub: "å‰§é™¢ä¸»äºº", icon: "ğŸ‘¤", type: "char" },
                    { id: '918', name: "9æœˆ18å·è´Ÿè´£äºº", sub: "ç°åœºç»Ÿç­¹", icon: "ğŸ‘¤", type: "char" }
                ]
            },
            neo: {
                title: "NeoÂ·æ‰§è¡Œé˜Ÿ", type: "CORP", color: "#ffffff",
                desc: `
                    ä½ç½®ï¼šå¸‚æ”¿ä¸­å¿ƒå¤§æ¥¼ã€‚<br><br>
                    å……æ»¡äº†ç™½è‰²æ—¥å…‰ç¯ã€ç”šè‡³æœ‰äº›åˆºçœ¼çš„åŠå…¬å¤§æ¥¼ã€‚è¿™é‡Œæ˜¯ç§©åºçš„è±¡å¾ã€‚
                `,
                list: [
                    { id: 'kai', name: "é˜Ÿé•¿ æº", sub: "Lazy Captain", icon: "ğŸ‘¤", type: "char" }
                ]
            },
            slums: {
                title: "å•†è´¸è´«æ°‘çªŸ", type: "ZONE", color: "#ff2a2a",
                desc: `
                    ä½ç½®ï¼šä¸‹å±‚åŒº Â· åºŸå¼ƒæ’æ±¡ç³»ç»Ÿå‘¨è¾¹ã€‚<br><br>
                    è¢«åŸå¸‚é—å¼ƒçš„åœ°æ–¹ã€‚è¿™é‡Œæ²¡æœ‰æ³•å¾‹ï¼Œåªæœ‰ç”Ÿå­˜æ³•åˆ™ã€‚
                `,
                list: [
                    { id: 'metro_station', name: "åºŸå¼ƒåœ°é“ç«™", sub: "å±…ä½åŒº", icon: "ğŸš‡", type: "shop" },
                    { id: 'clinic', name: "é»‘è¯Šæ‰€å…¥å£", sub: "åœ°ä¸‹è®¾æ–½", icon: "âœš", type: "shop" }
                ]
            },
            clinic: {
                title: "åå··è¯Šæ‰€", color: "#00ff99",
                address: "è´«æ°‘çªŸå…¥å£, åœ°ä¸‹å®¤", hours: "00:00 - 06:00",
                intro: "è™½ç„¶çœ‹èµ·æ¥åƒä¸ªå± å®°åœºï¼Œæ»¡åœ°éƒ½æ˜¯è¡€æ±¡çº±å¸ƒï¼Œä½†è¿™é‡Œçš„åŒ»ç”Ÿæ‹¥æœ‰ç¥ä¹‹æ‰‹ã€‚",
                npcs: [{ id: 'doc', name: "æ— ååŒ»ç”Ÿ", role: "å¤–ç§‘ä¸“å®¶", img: "åŒ»ç”Ÿ.jpg" }],
                menu: [
                    { id: 'painkiller', name: "å¼ºæ•ˆé•‡ç—›å‰‚", price: "1,200 CR", icon: "ğŸ’‰", type: "è¯å“", desc: "èƒ½å‹åˆ¶èµ›åšç²¾ç¥ç—…æ—©æœŸçš„å¹»å¬ç—‡çŠ¶ã€‚" },
                    { id: 'surgery', name: "å­å¼¹å–å‡ºæœ¯", price: "500 CR", icon: "ğŸ”ª", type: "æ‰‹æœ¯", desc: "ç‰©ç†å–å¼¹ï¼Œä¸æ‰“éº»è¯ã€‚" }
                ]
            },
            metro_station: {
                title: "åºŸå¼ƒåœ°é“ç«™", color: "#ff2a2a",
                address: "è´«æ°‘çªŸåœ°ä¸‹ B3", hours: "å·²åœè¿",
                intro: "æ—©å·²åºŸå¼ƒçš„æ—§æ—¶ä»£åœ°é“ç«™ã€‚ç°åœ¨è¢«æ— æ•°åº•å±‚äººå æ®ã€‚",
                npcs: [{ id: 'hobo', name: "è€æµæµªæ±‰", role: "åŒ…æ‰“å¬", img: "æµæµªæ±‰.jpg" }],
                menu: [
                    { id: 'rat_meat', name: "åˆæˆè‚‰ä¸²", price: "5 CR", icon: "ğŸ–", type: "é£Ÿç‰©", desc: "è™½ç„¶å«åˆæˆè‚‰ï¼Œä½†å…¶å®ä¸»è¦æ˜¯è€é¼ è‚‰ã€‚" },
                    { id: 'junk', name: "æ—§æ—¶ä»£åƒåœ¾", price: "10 CR", icon: "ğŸ—‘ï¸", type: "æ‚ç‰©", desc: "åæ‰çš„æ”¶éŸ³æœºã€åŠæˆªç”µæ± ã€çœ‹ä¸æ‡‚çš„ä¹¦ã€‚" }
                ]
            },
            power_plant: {
                title: "B-04 å˜ç”µç«™", color: "#0088ff",
                address: "å·¥ä¸šåŒº Sector-7", hours: "24h è¿ä½œ",
                intro: "è´Ÿè´£ä¾›ç»™ä¸‹å±‚åŒºç”µåŠ›çš„ä¸­æ¢è®¾æ–½ã€‚",
                npcs: [{ id: 'worker', name: "ç»´ä¿®å·¥", role: "NPC", img: "å·¥äºº.jpg" }],
                menu: [
                    { id: 'output', name: "è¾“å‡ºåŠŸç‡", price: "4800 MW", icon: "âš¡", type: "çŠ¶æ€", desc: "å½“å‰è´Ÿè½½ 92%ã€‚ç”µç½‘æ³¢åŠ¨ä¸­ã€‚" },
                    { id: 'temp', name: "æ ¸å¿ƒæ¸©åº¦", price: "89Â°C", icon: "ğŸŒ¡ï¸", type: "è­¦å‘Š", desc: "è¿‡çƒ­è­¦å‘Šã€‚å†·å´æ¶²æ³„éœ²ä¸­ã€‚" }
                ]
            },
            water_plant: {
                title: "å‡€æ°´å¾ªç¯å‚", color: "#0088ff",
                address: "å·¥ä¸šåŒº Sector-9", hours: "24h è¿ä½œ",
                intro: "å¤„ç†åŸå¸‚æ±¡æ°´çš„å·¨å‹å·¥å‚ã€‚",
                npcs: [{ id: 'guard', name: "ä¿å®‰", role: "NPC", img: "ä¿å®‰.jpg" }],
                menu: [
                    { id: 'ph', name: "PHå€¼ç›‘æµ‹", price: "6.2", icon: "ğŸ’§", type: "æ•°æ®", desc: "é…¸æ€§ç•¥é«˜ã€‚ç®¡é“è…èš€ä¸¥é‡ã€‚" },
                    { id: 'toxic', name: "é‡é‡‘å±å«é‡", price: "è¶…æ ‡", icon: "â˜¢ï¸", type: "è­¦å‘Š", desc: "æ£€æµ‹åˆ°å¾®é‡æ”¾å°„æ€§ç‰©è´¨ã€‚<br>è­¦å‘Šï¼šè¯·å‹¿ç›´æ¥é¥®ç”¨ã€‚" }
                ]
            },
            // è§’è‰²è¯¦æƒ… (å…¨æ‰å¹³è·¯å¾„)
            sojiro: { title: "ä½ä»“", role: "Coffee Master", img: "ä½ä»“.jpg", stats: { "å’–å•¡": "S", "é»‘å®¢": "A" }, bio: "å˜´ç¡¬å¿ƒè½¯çš„ä¸­å¹´ç»…å£«ã€‚å‰æ”¿åºœé¡¶çº§é»‘å®¢ã€‚è™½ç„¶å˜´ä¸ŠæŠ±æ€¨éº»çƒ¦ï¼Œä½†æ€»æ˜¯æ”¶ç•™æ— å®¶å¯å½’çš„â€˜æ€ªç›—â€™ã€‚<br><b>å¼±ç‚¹ï¼š</b> æåˆ°ä»–çš„å…»å¥³æ—¶ä¼šå˜å¾—éå¸¸æ„Ÿæ€§ã€‚" },
            kadoya: { title: "é—¨çŸ¢", role: "Photographer", img: "é—¨çŸ¢.jpg", stats: { "æ‘„å½±": "B-", "ç ´å": "S" }, bio: "è‡ªç§°â€œè·¯è¿‡çš„æ‘„å½±å¸ˆâ€ã€‚æ€§æ ¼å‚²æ…¢ã€‚è™½ç„¶æ‹ç…§æŠ€æœ¯ä¸€èˆ¬ï¼Œä½†ä»–åœ¨æƒ…æŠ¥æ”¶é›†å’Œä¼ªé€ èº«ä»½æ–¹é¢æ˜¯ç¥çº§çš„ä¸“å®¶ã€‚<br><b>åè¨€ï¼š</b> â€œç»™æˆ‘è®°å¥½äº†ã€‚â€" },
            kirei_npc: { title: "è¨€å³°ç¥çˆ¶", role: "Priest", img: "è¨€å³°.jpg", stats: { "æ„‰æ‚¦": "MAX", "å…«ææ‹³": "A" }, bio: "èº«èŒç¥èŒäººå‘˜ï¼Œä½†ä¼¼ä¹æ›´å–œæ¬¢çœ‹åˆ°äººç±»åœ¨ç—›è‹¦å’ŒæŒ£æ‰ä¸­å±•ç°å‡ºçš„å…‰è¾‰ã€‚å–éº»å©†è±†è…çº¯ç²¹æ˜¯ä¸ºäº†æ¬£èµå®¢äººä»¬æ‰­æ›²çš„è¡¨æƒ…ã€‚" },
            merchant: { title: "ç¥ç§˜å•†äºº", role: "Dealer", img: "å•†äºº.jpg", stats: { "åº“å­˜": "âˆ", "è´ªå©ª": "HIGH" }, bio: "æ²¡äººçŸ¥é“ä»–çš„åå­—ã€‚ä»–ä¼¼ä¹æ— å¤„ä¸åœ¨ã€‚åªè¦ä½ æ‰‹é‡Œæœ‰é’±ï¼Œä»–å°±æ˜¯ä½ æœ€å¥½çš„æœ‹å‹ã€‚<br><b>å£å¤´ç¦…ï¼š</b> â€œWhat are ya buyin'?â€" },
            doc: { title: "æ— ååŒ»ç”Ÿ", role: "Surgeon", img: "åŒ»ç”Ÿ.jpg", stats: { "åŒ»æœ¯": "SS", "é…’é‡": "C" }, bio: "å‰ç”Ÿç‰©ç§‘æŠ€å…¬å¸çš„é¡¶çº§åŒ»ç”Ÿï¼Œå› ä¸ºæŸäº›æœªå…¬å¼€çš„åŸå› è¿›å…¥è´«æ°‘çªŸï¼Œå¹¶ä¸ºè¿™äº›å®¶ä¼™æ²»ç—…ã€‚" },
            seizan: { title: "æ¾åŸé’è¡«", role: "Boss", img: "æ¾åŸ.jpg", stats: { "å‰‘é“": "SSS", "ç¥ç§˜": "MAX" }, bio: "ç»´æ–¯ä½©æ‹‰çš„å®¶ä¸»ã€‚æå°‘éœ²é¢ã€‚ä»–æ‹’ç»è¿›è¡Œä»»ä½•æœºæ¢°é£å‡æ”¹é€ ï¼ŒåšæŒä½¿ç”¨è‚‰ä½“å’Œå†·å…µå™¨ã€‚<br><b>åè¨€ï¼š</b> â€œè„äº†ï¼Œå°±æ“¦æ‰ã€‚â€" },
            shen: { title: "æ²ˆå¢¨å…°", role: "Maid Chief", img: "æ²ˆå¢¨å…°.jpg", stats: { "å¿ è¯š": "S", "è¿‘æˆ˜": "A+" }, bio: "<b>ç§°å·ï¼šé»‘æ›œçŸ³ä¹‹å£</b><br>å¥¹æ˜¯æ¾åŸé’è¡«æ„å¿—çš„æ‰§è¡Œè€…ã€‚å¤–è¡¨æ˜¯æ— å¯æŒ‘å‰”çš„å®Œç¾å¥³ä»†é•¿ï¼Œå®é™…ä¸Šæ˜¯ä»¤äººé—»é£ä¸§èƒ†çš„æ€æ‰‹ã€‚<br><b>è£…å¤‡ï¼š</b> å®šæµ· (é‡å‹é“é”¤)ã€‚" },
            kai: { title: "é˜Ÿé•¿ æº", role: "Captain", img: "æº.jpg", stats: { "æ‘¸é±¼": "S", "æˆ˜æ–—": "A" }, bio: "<b>ã€æ‡’æ•£çš„æ­£ä¹‰ã€‘</b><br>å¦‚æœä½ åœ¨åŠå…¬å®¤æ‰¾ä¸åˆ°ä»–ï¼Œé‚£ä»–ä¸€å®šæ˜¯åœ¨å¤©å°ç¡è§‰ã€‚è™½ç„¶çœ‹èµ·æ¥æ¯«æ— å¹²åŠ²ï¼Œä½†ä»–æ˜¯åœ¨è¿™æ³¥æ½­ä¹‹ä¸­ä»ç„¶æŠ±æœ‰æ­£ä¹‰çš„äººã€‚<br><b>å£å¤´ç¦…ï¼š</b> â€œå•Š...å¥½éº»çƒ¦ã€‚â€" },
            edward: { title: "çˆ±å¾·å", role: "Owner", img: "çˆ±å¾·å.jpg", stats: { "è´¢åŠ›": "SSS", "ç–¯ç‹‚": "A" }, bio: "äº¿ä¸‡å¯Œç¿ï¼Œè‰ºæœ¯ç‹‚çƒ­è€…ã€‚ä»–è®¤ä¸ºåªæœ‰æè‡´çš„æˆå‰§æ‰èƒ½æ­ç¤ºä¸–ç•Œçš„çœŸç›¸ã€‚" },
            '918': { title: "9æœˆ18å·", role: "Manager", img: "918.jpg", stats: { "å¿™ç¢Œ": "MAX", "ç„¦è™‘": "HIGH" }, bio: "ä¸€ä¸ªæ²¡æœ‰åå­—åªæœ‰ä»£å·çš„ä¸­å¹´ç¤¾ç•œã€‚ä»–çš„IDå¡æƒé™æé«˜ã€‚å¦‚æœä½ æƒ³æ··å…¥åå°ï¼Œæå®šä»–æ˜¯æœ€å¿«çš„æ–¹æ³•ã€‚" },
            worker: { title: "ç»´ä¿®å·¥", role: "NPC", img: "å·¥äºº.jpg", stats: { "æŠ±æ€¨": "MAX" }, bio: "ä¸€ä¸ªæå…¶æ™®é€šçš„ç»´ä¿®å·¥äººã€‚æ¯å¤©éƒ½åœ¨è¯…å’’è¿™ä¸ªè¯¥æ­»çš„å˜ç”µç«™å’Œåå•¬çš„è€æ¿ã€‚" },
            guard: { title: "ä¿å®‰", role: "NPC", img: "ä¿å®‰.jpg", stats: { "å‘å‘†": "MAX" }, bio: "æ­£åœ¨æ‰“çŒç¡ã€‚åªè¦ä¸åµé†’ä»–ï¼Œä½ ç”šè‡³å¯ä»¥æ¬èµ°é—¨å£çš„çŸ³ç‹®å­ã€‚" },
            hobo: { title: "è€æµæµªæ±‰", role: "NPC", img: "æµæµªæ±‰.jpg", stats: { "ç”Ÿå­˜": "A" }, bio: "åœ¨è¿™é‡Œä½äº†äºŒåå¹´ã€‚ä»–çŸ¥é“å“ªæ¡ä¸‹æ°´é“é€šå¾€ä¸Šå±‚åŒºï¼Œä¹ŸçŸ¥é“å“ªç§è€é¼ è‚‰æœ€å¥½åƒã€‚" }
        };

        // ================== ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘ ==================
        let zIndex = 100;
        const workspace = document.getElementById('map-container');

        function createWindow(id, title, color, width, height) {
            const win = document.createElement('div');
            win.className = 'window';
            win.style.width = width + 'px';
            win.style.height = height + 'px';
            win.style.borderColor = color;
            win.style.zIndex = ++zIndex;
            
            const left = 50 + Math.random() * 150;
            const top = 50 + Math.random() * 80;
            win.style.left = left + 'px';
            win.style.top = top + 'px';

            win.innerHTML = `
                <div class="win-header" style="background:${color}22">
                    <div class="win-title">
                        <span style="display:inline-block; width:8px; height:8px; background:${color}; margin-right:8px;"></span>
                        <span class="glitch" data-text="${title}">${title}</span>
                    </div>
                    <div class="close-btn">Ã—</div>
                </div>
                <div class="win-body" id="win-body-${id}"></div>
            `;

            win.querySelector('.close-btn').onclick = (e) => {
                e.stopPropagation();
                win.style.opacity = 0;
                setTimeout(() => win.remove(), 200);
            };
            win.onmousedown = () => { win.style.zIndex = ++zIndex; };
            dragElement(win);
            workspace.appendChild(win);
            return win.querySelector(`#win-body-${id}`);
        }

        // ç”ŸæˆåŒºåŸŸ
        function spawnZone(key) {
            const data = db[key];
            if(!data) return;

            if(data.type === 'CORP') {
                const body = createWindow(key, data.title, data.color, 380, 500);
                let html = `<div style="padding:20px;">
                    <div class="zone-desc" style="margin-bottom:20px;">${data.desc}</div>
                    <div class="menu-header">PERSONNEL</div>
                `;
                data.list.forEach(item => {
                    html += `
                        <div class="entry-item" onclick="spawnChar('${item.id}', '${data.color}')">
                            <div class="ei-icon">${item.icon}</div>
                            <div>
                                <div style="color:#fff; font-weight:bold;">${item.name}</div>
                                <div style="font-size:0.8rem; color:#888;">${item.sub}</div>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
                body.innerHTML = html;
            } else {
                const body = createWindow(key, data.title, data.color, 380, 550);
                let html = `
                    <div class="zone-banner">
                        <div class="zone-desc">${data.desc}</div>
                    </div>
                    <div class="menu-header">FACILITIES</div>
                    <div class="entry-list">
                `;
                data.list.forEach(item => {
                    html += `
                        <div class="entry-item" onclick="spawnShop('${item.id}')">
                            <div class="ei-icon">${item.icon}</div>
                            <div>
                                <div style="color:#fff; font-weight:bold;">${item.name}</div>
                                <div style="font-size:0.8rem; color:#888;">${item.sub}</div>
                            </div>
                            <div style="margin-left:auto; color:${data.color}">âœ</div>
                        </div>
                    `;
                });
                html += `</div>`;
                body.innerHTML = html;
            }
        }

        // ç”Ÿæˆå•†åº—
        function spawnShop(shopId) {
            const data = db[shopId];
            if(!data) return;

            const body = createWindow(shopId, data.title, data.color, 780, 550);
            body.parentNode.classList.add('shop-window');

            body.innerHTML = `
                <div class="shop-container">
                    <div class="shop-sidebar">
                        <div class="shop-meta-block"><strong>ADDRESS</strong>${data.address}</div>
                        <div class="shop-meta-block"><strong>HOURS</strong>${data.hours}</div>
                        <div class="shop-meta-block"><strong>INTRO</strong>${data.intro}</div>
                        <div style="margin-top:auto;">
                            <div class="menu-header" style="padding-left:0; border:none;">STAFF</div>
                            ${data.npcs.map(npc => `
                                <div class="npc-mini-card" onclick="spawnChar('${npc.id}', '${data.color}')">
                                    <div class="npc-mini-avatar">
                                        <img src="${npc.img}" onerror="this.style.display='none'">
                                    </div>
                                    <div>
                                        <div style="font-weight:bold; color:#fff; font-size:0.8rem;">${npc.name}</div>
                                        <div style="font-size:0.7rem; color:${data.color}">${npc.role}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="shop-main">
                        <div class="menu-header" style="background:${data.color}11; color:${data.color}">CATALOG // ${data.menu.length} ENTRIES</div>
                        <div class="goods-grid">
                            ${data.menu.map(item => `
                                <div class="item-card" onclick="showItemDetail('${item.id}', '${shopId}')">
                                    <div class="item-stock">INSTOCK</div>
                                    <div class="item-icon">${item.icon}</div>
                                    <div class="item-name">${item.name}</div>
                                    <div class="item-price">${item.price}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="item-detail-overlay" id="detail-${shopId}"></div>
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤ºè¯¦æƒ…
        function showItemDetail(itemId, shopId) {
            const item = db[shopId].menu.find(i => i.id === itemId);
            const overlay = document.getElementById(`detail-${shopId}`);
            
            overlay.innerHTML = `
                <div class="detail-img">${item.icon}</div>
                <div class="detail-info">
                    <div style="font-size:1.1rem; font-weight:bold; color:#fff; margin-bottom:5px;">
                        <span class="glitch" data-text="${item.name}">${item.name}</span> 
                        <span style="float:right; color:var(--primary)">${item.price}</span>
                    </div>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <span style="padding:2px 6px; font-size:0.7rem; background:#333; border-radius:2px;">${item.type}</span>
                    </div>
                    <div style="font-size:0.9rem; color:#ccc; line-height:1.5;">${item.desc}</div>
                </div>
                <button onclick="this.parentNode.classList.remove('active')" style="position:absolute; top:5px; right:10px; background:none; border:none; color:#555; cursor:pointer; font-size:1.5rem;">Ã—</button>
            `;
            overlay.classList.add('active');
        }

        // ç”Ÿæˆè§’è‰²
        function spawnChar(charId, color) {
            const data = db[charId];
            if(!data) return;
            const body = createWindow(charId, "PROFILE: " + data.title, color, 450, 350);
            body.style.padding = "20px";
            body.innerHTML = `
                <div style="display:flex; gap:20px; height:100%;">
                    <div style="width:120px; height:150px; background:#000; border:1px solid #333; flex-shrink:0;">
                        <img src="${data.img}" onerror="this.style.display='none'" style="width:100%; height:100%; object-fit:cover;">
                    </div>
                    <div style="flex:1;">
                        <h2 style="margin:0; color:#fff;" class="glitch" data-text="${data.title}">${data.title}</h2>
                        <div style="color:${color}; margin-bottom:10px; font-family:'Share Tech Mono'">// ${data.role}</div>
                        ${Object.entries(data.stats).map(([k,v]) => `
                            <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:4px;">
                                <span style="color:#888;">${k}</span><span style="color:#fff;">${v}</span>
                            </div>
                            <div style="height:2px; background:#333; width:100%; margin-bottom:8px;"><div style="height:100%; background:${color}; width:${Math.random()*50+50}%"></div></div>
                        `).join('')}
                    </div>
                </div>
                <div style="margin-top:15px; font-size:0.9rem; color:#ccc; line-height:1.5; border-top:1px dashed #333; padding-top:10px;">${data.bio}</div>
            `;
        }

        // æ‹–æ‹½å‡½æ•°
        function dragElement(elmnt) {
            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const header = elmnt.querySelector('.win-header');
            if (header) header.onmousedown = dragMouseDown;
            function dragMouseDown(e) {
                if(e.target.classList.contains('close-btn')) return;
                e = e || window.event; e.preventDefault();
                pos3 = e.clientX; pos4 = e.clientY;
                document.onmouseup = closeDragElement; document.onmousemove = elementDrag;
                elmnt.style.zIndex = ++zIndex;
            }
            function elementDrag(e) {
                e = e || window.event; e.preventDefault();
                pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
                pos3 = e.clientX; pos4 = e.clientY;
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            }
            function closeDragElement() { document.onmouseup = null; document.onmousemove = null; }
        }

        // ================== Matrix ä»£ç é›¨ (å¼ºåŠ›ä¿®å¤ç‰ˆ) ==================
        const matrixChars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"; 
        
        function initMatrix(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return; // å®‰å…¨æ£€æŸ¥

            const ctx = canvas.getContext('2d');
            const parent = canvas.parentElement;

            // 1. å¼ºåˆ¶è®¾å®šå°ºå¯¸
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight;

            // å¦‚æœé«˜åº¦æ˜¯0ï¼ˆéšè—çŠ¶æ€ï¼‰ï¼Œåˆ™ä¸æ‰§è¡Œ
            if (canvas.width === 0 || canvas.height === 0) return;

            const fontSize = 16; // å­—ä½“æ”¹å¤§ä¸€ç‚¹
            const columns = Math.ceil(canvas.width / fontSize);
            const drops = [];
            for (let i = 0; i < columns; i++) {
                drops[i] = Math.random() * -100;
            }

            function draw() {
                // é»‘è‰²èƒŒæ™¯ï¼Œå¸¦ä¸€ç‚¹é€æ˜åº¦å½¢æˆæ‹–å½±
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // äº®ç»¿è‰²æ–‡å­—ï¼Œä½¿ç”¨ç­‰å®½å­—ä½“
                ctx.fillStyle = '#0F0'; 
                ctx.font = '700 ' + fontSize + 'px monospace'; 

                for (let i = 0; i < drops.length; i++) {
                    const text = matrixChars.charAt(Math.floor(Math.random() * matrixChars.length));
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
            }

            if (canvas.matrixInterval) clearInterval(canvas.matrixInterval);
            canvas.matrixInterval = setInterval(draw, 33);
        }

        function startRain() {
            // æ— è®ºçª—å£å¤§å°ï¼Œåªè¦ä¾§è¾¹æ å­˜åœ¨å°±å°è¯•æ¸²æŸ“
            initMatrix('canvas-left');
            initMatrix('canvas-right');
        }
        
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(startRain, 100);
        });

        // ç¡®ä¿è„šæœ¬åŠ è½½åç«‹å³è¿è¡Œä¸€æ¬¡
        startRain();

        // æ—¶é’Ÿ
        setInterval(() => { 
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('en-GB'); 
        }, 1000);

    </script>
</body>
</html>