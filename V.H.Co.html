<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V.H.C. TERMINAL V7</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00f3ff;
            --bg: #050505;
            --glass: rgba(10, 20, 30, 0.95);
            --red: #ff3333;
            --user-msg-bg: rgba(0, 243, 255, 0.15);
        }

        body {
            margin: 0; background-color: var(--bg); color: #fff;
            font-family: 'Rajdhani', sans-serif; overflow: hidden; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            touch-action: pan-y;
        }

        /* --- 背景动画 --- */
        .bg-grid {
            position: absolute; width: 200%; height: 200%; top: -50%; left: -50%;
            background-image: 
                linear-gradient(rgba(0, 255, 204, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 204, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            transform: perspective(500px) rotateX(60deg);
            animation: planeMove 10s linear infinite;
            z-index: -2;
        }
        @keyframes planeMove { from {transform: perspective(500px) rotateX(60deg) translateY(0);} to {transform: perspective(500px) rotateX(60deg) translateY(50px);} }

/* --- 新增样式：断开连接按钮 --- */
.btn-disconnect {
    background: transparent;
    border: 1px solid var(--red);
    color: var(--red);
    font-family: 'Orbitron';
    font-weight: bold;
    cursor: pointer;
    padding: 2px 8px;
    transition: 0.3s;
}
.btn-disconnect:hover {
    background: var(--red);
    color: #000;
    box-shadow: 0 0 10px var(--red);
}

/* --- 新增样式：结算页返回按钮 --- */
.return-btn {
    margin-top: 15px; /* 与复制按钮拉开距离 */
    border-color: var(--primary);
    color: var(--primary);
}
.return-btn:hover {
    background: var(--primary);
    color: #000;
    box-shadow: 0 0 20px var(--primary);
}

        /* --- 轮播容器 --- */
        .slider-container { width: 95%; max-width: 1100px; height: 75vh; position: relative; perspective: 1000px; }

        .slide {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; background: var(--glass);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(15px);
            clip-path: polygon(40px 0, 100% 0, 100% calc(100% - 40px), calc(100% - 40px) 100%, 0 100%, 0 40px);
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            opacity: 0; transform: translateX(100px) scale(0.9); pointer-events: none;
            transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .slide.active { opacity: 1; transform: translateX(0) scale(1); pointer-events: all; z-index: 10; }

        .char-visual { flex: 1; position: relative; overflow: hidden; border-right: 2px solid rgba(255,255,255,0.1); }
        .char-img { width: 100%; height: 100%; object-fit: cover; object-position: center top; filter: saturate(0.8) contrast(1.1); transition: 0.5s; }
        .slide.active .char-img { transform: scale(1.05); }

        .char-data { flex: 0.9; padding: 40px; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .char-name-en { font-family: 'Orbitron'; font-size: 3.5rem; color: transparent; -webkit-text-stroke: 1px var(--theme); opacity: 0.3; margin: 0; line-height: 0.8; position: absolute; top: 20px; right: 20px; text-align: right;}
        .char-name-cn { font-size: 3rem; font-weight: 700; margin-top: 60px; color: #fff; text-shadow: 0 0 20px var(--theme); z-index: 2;}
        .char-role { color: var(--theme); font-family: 'Courier New'; font-weight: bold; letter-spacing: 2px; margin-bottom: 20px; z-index: 2;}
        .char-desc { font-size: 1.1rem; line-height: 1.6; color: #bbb; margin-bottom: 40px; border-left: 4px solid var(--theme); padding-left: 20px; z-index: 2; max-width: 80%; }

        .btn-call {
            width: 200px; padding: 15px; font-family: 'Orbitron'; font-size: 1.2rem; font-weight: 900;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05));
            color: var(--theme); border: 2px solid var(--theme);
            cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
            transition: 0.3s; z-index: 5;
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
        }
        .btn-call:hover { background: var(--theme); color: #000; box-shadow: 0 0 30px var(--theme); padding-left: 25px;}

        /* --- 导航按钮 --- */
        .nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 60px; height: 100px;
            background: rgba(0,0,0,0.8); border: 2px solid var(--primary);
            color: var(--primary); font-size: 2rem; font-family: 'Orbitron';
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 100; transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
        }
        .nav-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 30px var(--primary); }
        .prev-btn { left: 2%; clip-path: polygon(20px 0, 100% 0, 100% 100%, 0 50%); }
        .next-btn { right: 2%; clip-path: polygon(0 0, calc(100% - 20px) 0, 100% 50%, 0 100%); }

        /* --- 聊天界面 --- */
        .dialogue-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
            z-index: 200; display: none; justify-content: center; align-items: center;
        }

        .comm-interface {
            width: 90%; max-width: 700px; height: 85vh;
            background: #080808; border: 2px solid var(--current-theme);
            display: flex; flex-direction: column;
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
            position: relative;
        }

        .comm-header {
            padding: 15px; border-bottom: 1px solid #333;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.05);
        }
        .comm-status { font-family: 'Orbitron'; font-size: 0.8rem; color: var(--current-theme); letter-spacing: 2px; }

        .chat-history {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            scroll-behavior: smooth;
        }

        .msg { max-width: 80%; padding: 12px 18px; font-size: 1rem; line-height: 1.5; position: relative; animation: popIn 0.3s; }
        @keyframes popIn { from{opacity: 0; transform: translateY(10px);} to{opacity: 1; transform: translateY(0);} }

        .msg.char {
            align-self: flex-start; background: #1a1a1a;
            border-left: 3px solid var(--current-theme); color: #ddd;
            border-top-right-radius: 10px; border-bottom-right-radius: 10px;
        }
        .msg.char::before { content: attr(data-sender); font-size: 0.7rem; color: var(--current-theme); position: absolute; top: -18px; left: 0; }

        .msg.user {
            align-self: flex-end; background: var(--user-msg-bg);
            border: 1px solid var(--primary); color: #fff;
            border-top-left-radius: 10px; border-bottom-left-radius: 10px;
        }

        .options-area {
            padding: 15px; background: #000; border-top: 1px solid #333;
            display: grid; gap: 8px;
        }

        .option-btn {
            background: transparent; border: 1px solid #555; color: #aaa;
            padding: 15px; text-align: left; cursor: pointer; transition: 0.2s;
            font-family: 'Rajdhani'; font-weight: 700; font-size: 0.95rem;
        }
        .option-btn:hover { border-color: #fff; color: #fff; background: rgba(255,255,255,0.1); }
        .option-btn.emergency { 
            border: 1px solid #800; color: #f44; background: rgba(50,0,0,0.3); 
            font-weight: 900; letter-spacing: 1px;
        }
        .option-btn.emergency:hover { background: var(--red); color: #fff; box-shadow: 0 0 20px var(--red); }

        /* --- 最终加载界面 --- */
        .deploy-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 300; display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }

        .spinner-container { position: relative; width: 200px; height: 200px; margin-bottom: 40px; }
        .ring { position: absolute; border-radius: 50%; border: 2px solid transparent; }
        .r1 { top: 0; left: 0; width: 100%; height: 100%; border-top: 4px solid var(--primary); animation: spin 2s linear infinite; }
        .r2 { top: 10%; left: 10%; width: 80%; height: 80%; border-bottom: 4px solid var(--red); animation: spin 3s linear infinite reverse; }
        .r3 { top: 30%; left: 30%; width: 40%; height: 40%; border-left: 4px solid #fff; animation: spin 1s linear infinite; }
        .radar-scan { position: absolute; top: 5%; left: 5%; width: 90%; height: 90%; border-radius: 50%; background: conic-gradient(from 0deg, transparent 70%, rgba(0, 243, 255, 0.2)); animation: spin 4s linear infinite; }
        @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }

        .deploy-title { font-family: 'Orbitron'; font-size: 3rem; color: #fff; text-shadow: 0 0 20px var(--current-theme); margin-bottom: 10px; text-align: center;}
        .deploy-name { font-family: 'Orbitron'; font-size: 4rem; color: var(--current-theme); font-weight: 900; letter-spacing: 5px; text-align: center; animation: pulse 1s infinite alternate;}
        @keyframes pulse { from{opacity:0.8; transform: scale(1);} to{opacity:1; transform: scale(1.05);} }
        
        .copy-btn {
            margin-top: 50px; padding: 10px 20px; border: 1px solid #555; color: #888; background: transparent;
            font-family: 'Courier New'; cursor: pointer; transition: 0.3s;
        }
        .copy-btn:hover { border-color: #fff; color: #fff; }

        .theme-kotone { --theme: #bd93f9; }
        .theme-rika { --theme: #00f3ff; }
        .theme-midori { --theme: #50fa7b; }
        .theme-aoi { --theme: #ffb86c; }

        @media (max-width: 768px) {
            .slide { flex-direction: column; }
            .char-visual { height: 40%; border-right: none; border-bottom: 2px solid rgba(255,255,255,0.1); }
            .char-data { height: 60%; padding: 20px; }
            .char-name-en { font-size: 2rem; }
            .char-name-cn { margin-top: 10px; font-size: 2rem; }
            .nav-btn { display: none; }
            .deploy-name { font-size: 2.5rem; }
        }
    </style>
</head>
<body>

    <div class="bg-grid"></div>

    <div class="slider-container" id="slider">
        <div class="slide theme-kotone active" data-id="0" data-color="#bd93f9">
            <div class="char-visual"><img src="kotone.jpg" class="char-img"></div>
            <div class="char-data">
                <h1 class="char-name-en">MOCHIZUKI</h1>
                <h2 class="char-name-cn">望月 琴音</h2>
                <div class="char-role">TACTICAL SNIPER</div>
                <p class="char-desc">“新人君，战斗不是儿戏。如果感到害怕，就抬头看看月亮吧——我会在那里掩护你。”</p>
                <button class="btn-call" onclick="startChat(0)">建立连接</button>
            </div>
        </div>
        <div class="slide theme-rika" data-id="1" data-color="#00f3ff">
            <div class="char-visual"><img src="rika.jpg" class="char-img"></div>
            <div class="char-data">
                <h1 class="char-name-en">SAMEJIMA</h1>
                <h2 class="char-name-cn">鮫島 莉卡</h2>
                <div class="char-role">ASSAULT / DRIVER</div>
                <p class="char-desc">“喂喂？是哪个倒霉的菜鸟被包围了？只要价钱合适，我连地狱的单行道都能给你逆行开回来！”</p>
                <button class="btn-call" onclick="startChat(1)">建立连接</button>
            </div>
        </div>
        <div class="slide theme-midori" data-id="2" data-color="#50fa7b">
            <div class="char-visual"><img src="midori.jpg" class="char-img"></div>
            <div class="char-data">
                <h1 class="char-name-en">KIRYUU</h1>
                <h2 class="char-name-cn">桐生 翠</h2>
                <div class="char-role">ELITE CLEANER</div>
                <p class="char-desc">“见习生，请记住：高效的清洁往往不需要太多的洗涤剂，只需要精准的一刀。”</p>
                <button class="btn-call" onclick="startChat(2)">建立连接</button>
            </div>
        </div>
        <div class="slide theme-aoi" data-id="3" data-color="#ffb86c">
            <div class="char-visual"><img src="aoi.jpg" class="char-img"></div>
            <div class="char-data">
                <h1 class="char-name-en">WAKIKO</h1>
                <h2 class="char-name-cn">和狐 葵</h2>
                <div class="char-role">GUARDIAN</div>
                <p class="char-desc">“啊啦，迷路的孩子吗？别担心，妈妈已经把热水烧好了。只要你能跑回来，这里就是绝对安全的。”</p>
                <button class="btn-call" onclick="startChat(3)">建立连接</button>
            </div>
        </div>
    </div>

    <div class="nav-btn prev-btn" onclick="changeSlide(-1)"> < </div>
    <div class="nav-btn next-btn" onclick="changeSlide(1)"> > </div>

    <div class="dialogue-overlay" id="chatOverlay">
        <div class="comm-interface" id="commInterface">
            <div class="comm-header">
                <span id="chatTitle">SECURE CONNECTION</span>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span class="comm-status" id="signalStatus">SIGNAL: 100%</span>
                    <button class="btn-disconnect" onclick="closeChat()">[ X ]</button>
                </div>
            </div>
            
            <div class="chat-history" id="chatHistory"></div>
            
            <div class="options-area" id="optionsArea"></div>
        </div>
    </div>

    <div class="deploy-screen" id="deployScreen">
        <div class="spinner-container">
            <div class="ring r1"></div><div class="ring r2"></div><div class="ring r3"></div><div class="radar-scan"></div>
        </div>
        <div class="deploy-title">SUPPORT UNIT INBOUND</div>
        <div class="deploy-name" id="deployNameText">UNKNOWN</div>
        <div style="color:#aaa; font-family:'Courier New'; margin-top:20px;">ETA: 00:03:00</div>
        
        <button class="copy-btn" onclick="copyLog()">[ 复制通讯记录 (COPY LOG) ]</button>
        <button class="copy-btn return-btn" onclick="resetSystem()">[ 返回终端首页 (REBOOT) ]</button>
        <div id="copyHint" style="color: var(--primary); font-size: 0.8rem; margin-top: 5px; opacity: 0; transition: 0.5s;">已复制！请发送给GM</div>
    </div>

    <script>
        /* --- 轮播与手势 --- */
        let currentIdx = 0;
        const slides = document.querySelectorAll('.slide');
        
        function changeSlide(dir) {
            slides[currentIdx].classList.remove('active');
            currentIdx = (currentIdx + dir + slides.length) % slides.length;
            slides[currentIdx].classList.add('active');
        }

        let startX = 0;
        const container = document.getElementById('slider');
        container.addEventListener('touchstart', e => startX = e.touches[0].clientX);
        container.addEventListener('touchend', e => {
            if (Math.abs(startX - e.changedTouches[0].clientX) > 50) {
                changeSlide(startX > e.changedTouches[0].clientX ? 1 : -1);
            }
        });

        /* --- 剧本数据 (包含 finalLine 和 emergencyLine) --- */
        const scripts = {
            0: { 
                name: "月影·琴音", 
                finalLine: "路线已确认。箭矢上弦。新人君，跟着我的视线走，别回头。",
                emergencyLine: "什么？！情况恶化了？啧...别慌，我这就在这个位置开个洞！趴下！",
                steps: [
                    {
                        npc: "这里是琴音。新人君，你的心率有点高。第一次执行外勤任务紧张是正常的。深呼吸，告诉我你现在看到什么了？",
                        opts: [{ text: "前面黑漆漆的，我什么都看不见...", next: 1 }, { text: "我好像听到墙壁后面有声音。", next: 2 }]
                    },
                    {
                        npc: "视野受限吗？没关系。我已经打开了热成像模式。在你左前方120米处有两个热源，看起来像是在巡逻。需要我帮你标记路线吗？",
                        opts: [{ text: "拜托了，我想悄悄绕过去。", next: 3 }, { text: "只要两个？那我应该能应付。", next: 4 }]
                    },
                    {
                        npc: "听觉很敏锐嘛，新人君。那是重型机械单位的液压声。它们装甲很厚，但关节处是弱点。你手里的武器穿透力不够，不要硬拼。",
                        opts: [{ text: "那我该怎么办？在这个掩体躲着？", next: 3 }, { text: "如果我用EMP手雷呢？", next: 4 }]
                    },
                    {
                        npc: "明智的选择。我已经将安全路线投射到你的护目镜上了。跟着绿色的光标走。如果有人回头，我会第一时间射穿他的电子眼。",
                        opts: [{ text: "明白，开始移动。", next: 5 }, { text: "琴音姐，有你在真安心。", next: 5 }]
                    },
                    {
                        npc: "既然你有信心，那我也不拦着。但我会一直瞄准那个大个子的燃料罐。万一你失手了，记得立刻趴下，我会引爆它。",
                        opts: [{ text: "收到！准备突击！", next: 5 }, { text: "好，倒数三二一一起动手。", next: 5 }]
                    },
                    {
                        npc: "很好，保持这个节奏。新人君，虽然你是第一次，但意外地很有天赋呢。别死在这里哦，结束之后请你喝茶。",
                        opts: [{ text: "任务继续！(MISSION START)", next: 99 }]
                    }
                ]
            },
            1: { 
                name: "狂鲨·莉卡", 
                finalLine: "油门已经焊死在底盘上了！别死了啊，菜鸟！三秒后撞击！",
                emergencyLine: "啊啊啊烦死了！不管了！我要把这一整条街都炸飞！不想变烤肉就快跑！！",
                steps: [
                    {
                        npc: "喂——菜鸟！听得见吗？我是莉卡！天呐，你那边是开鞭炮厂吗？爆炸声我隔着五公里都听到了！",
                        opts: [{ text: "我被包围了！火力太猛了！", next: 1 }, { text: "别废话了，车呢？！", next: 2 }]
                    },
                    {
                        npc: "哈哈哈哈！这才像样嘛！黄昏家政的入职仪式都是这么火爆的！别慌，告诉我，你是想悄悄溜走，还是想搞个大新闻？",
                        opts: [{ text: "我想活着回去！快来接我！", next: 3 }, { text: "既然都这样了，不如把他们都炸飞！", next: 4 }]
                    },
                    {
                        npc: "催什么催！我的宝贝‘巨齿鲨’正在预热呢！前面的路被堵死了，你是想让我撞穿那堵墙，还是从二楼飞上来接你？",
                        opts: [{ text: "撞墙！我要那种帅气的登场！", next: 4 }, { text: "二楼太高了吧...还是走正门吧。", next: 3 }]
                    },
                    {
                        npc: "切，真没劲。好吧，我会从后巷切入。待会儿你会看到一辆冒着蓝火的卡车，记得跑快点，我可不会停车等你！",
                        opts: [{ text: "知道了，我这就往后巷跑！", next: 5 }, { text: "给我留个车门！", next: 5 }]
                    },
                    {
                        npc: "哟吼！我就喜欢你这种不要命的菜鸟！后备箱里有你的鲨鱼矛，还有两箱C4。让我们把这地方变成废墟吧！",
                        opts: [{ text: "来吧！大闹一场！", next: 5 }, { text: "为了黄昏家政！", next: 5 }]
                    },
                    {
                        npc: "抓紧扶手！我们要起飞了！3，2，1——点火！！！",
                        opts: [{ text: "RIDE ON!! (DEPLOY)", next: 99 }]
                    }
                ]
            },
            2: { 
                name: "翡翠·翠", 
                finalLine: "申请已通过。功率全开。见习生，请闭眼，接下来的画面会有些...血腥。",
                emergencyLine: "啧...既然情况失控，那就没必要保持优雅了。全员抹杀模式，启动！",
                steps: [
                    {
                        npc: "见习生。检测到你的生命体征波动异常。看来现场的‘污渍’比预想的要顽固。需要前辈来教你怎么大扫除吗？",
                        opts: [{ text: "翠前辈！这里的敌人太多了！", next: 1 }, { text: "我还能坚持，但装备快没电了。", next: 2 }]
                    },
                    {
                        npc: "数量多并不是借口。只要挥剑的速度够快，再多的垃圾也能瞬间清理。你是想让我直接切入战场，还是在侧翼支援？",
                        opts: [{ text: "请直接切入！我需要火力分担！", next: 3 }, { text: "在侧翼就好，我不想误伤。", next: 3 }]
                    },
                    {
                        npc: "装备维护也是女仆的必修课。回去之后记得写一千字的检讨。现在，把位置发给我，我会用最近的路线赶过去。",
                        opts: [{ text: "是...我知道了。位置已发送。", next: 4 }, { text: "一千字？！能不能少点...", next: 4 }]
                    },
                    {
                        npc: "了解。既然选择了物理清除，那么请务必闭上眼睛。接下来的画面，可能不太适合新人观看。会有很多...红色的颜料。",
                        opts: [{ text: "我会注意避让的。", next: 5 }, { text: "我也要战斗！", next: 5 }]
                    },
                    {
                        npc: "检讨书的事回去再说。现在，集中精神。那柄剑不是装饰品，让它动起来。我会在三秒后抵达。",
                        opts: [{ text: "明白，坚守阵地。", next: 5 }, { text: "等你过来，前辈。", next: 5 }]
                    },
                    {
                        npc: "翡翠之刃，出鞘。见习生，好好看着，这才是黄昏家政的清洁标准。",
                        opts: [{ text: "请求清理开始！(DEPLOY)", next: 99 }]
                    }
                ]
            },
            3: { 
                name: "和狐·葵", 
                finalLine: "乖孩子。不要怕，妈妈已经到了。现在，谁也别想伤害你。",
                emergencyLine: "竟然敢把我的孩子逼到这种地步...不可原谅...绝对不可原谅！！",
                steps: [
                    {
                        npc: "啊啦，这不是迷路的孩子吗？怎么弄得这么狼狈？身上都是灰尘，衣服也破了...真是让人心疼呢。",
                        opts: [{ text: "葵妈妈...我好像走不出去了。", next: 1 }, { text: "受了一点小伤，不碍事。", next: 2 }]
                    },
                    {
                        npc: "嘘——别说丧气话。只要妈妈还在，就不会让你有事的。告诉我，哪里最疼？",
                        opts: [{ text: "腿受伤了，动不了...", next: 3 }, { text: "心里...有点害怕。", next: 4 }]
                    },
                    {
                        npc: "逞强的孩子。有时候依赖一下大人也是可以的哦。要是留下疤痕，将来可就不好看。快，到妈妈这边来。",
                        opts: [{ text: "我这就过去。", next: 3 }, { text: "可是敌人还在后面...", next: 3 }]
                    },
                    {
                        npc: "没关系，没关系。我已经展开了‘家守结界’。那些坏孩子如果敢靠近，会被狐火烧屁股的哦。你只需要安心休息就好。",
                        opts: [{ text: "结界...真的安全吗？", next: 5 }, { text: "谢谢妈妈...", next: 5 }]
                    },
                    {
                        npc: "害怕也没关系哦。妈妈会给你泡一杯热腾腾的抹茶，加了很多糖。喝下去，噩梦就会消散了。",
                        opts: [{ text: "我想喝抹茶...", next: 5 }, { text: "我想回家。", next: 5 }]
                    },
                    {
                        npc: "好了，闭上眼睛数三声。再睁开眼的时候，我们就已经到家了。乖孩子。",
                        opts: [{ text: "带我回家。(DEPLOY)", next: 99 }]
                    }
                ]
            }
        };

        /* --- 核心逻辑 --- */
        let currentScript = null;
        let charName = "";
        let chatLog = []; // 存储聊天记录

        function startChat(charId) {
            const slide = document.querySelector(`.slide[data-id="${charId}"]`);
            const color = slide.getAttribute('data-color');
            charName = scripts[charId].name;
            currentScript = scripts[charId];
            chatLog = []; // 重置记录
            chatLog.push(`[SYSTEM] Connected to ${charName}`);

            document.getElementById('commInterface').style.setProperty('--current-theme', color);
            document.getElementById('deployScreen').style.setProperty('--current-theme', color); // 同步颜色给加载屏
            document.getElementById('chatTitle').innerText = "LINK: " + charName;
            document.getElementById('chatHistory').innerHTML = "";
            document.getElementById('optionsArea').innerHTML = "";
            document.getElementById('chatOverlay').style.display = "flex";

            playStep(0);
        }

        function playStep(stepId) {
            // 这里我们不直接处理 99，99 在 userSelect 里处理
            const stepData = currentScript.steps[stepId];
            showTypingIndicator();
            
            setTimeout(() => {
                removeTypingIndicator();
                addMessage("char", stepData.npc);
                showOptions(stepData.opts);
            }, 600);
        }

        function userSelect(text, nextId) {
            addMessage("user", text);
            document.getElementById('optionsArea').innerHTML = ""; // 隐藏选项

            // 检查是否是紧急按钮
            if (text.includes("紧急") || text.includes("救命") || text.includes("EMERGENCY") || text.includes("SOS") || text.includes("DANGER") || text.includes("HELP") || text.includes("FAIL")) {
                // 触发紧急流程
                triggerFinalSequence(true);
            } 
            else if (nextId === 99) {
                // 触发正常结束流程
                triggerFinalSequence(false);
            } 
            else {
                // 继续对话
                playStep(nextId);
            }
        }

        function triggerFinalSequence(isEmergency) {
            // 1. 显示最终台词
            showTypingIndicator();
            setTimeout(() => {
                removeTypingIndicator();
                const finalMsg = isEmergency ? currentScript.emergencyLine : currentScript.finalLine;
                addMessage("char", finalMsg);
                
                // 2. 延迟 3 秒后跳转
                setTimeout(() => {
                    showDeployScreen();
                }, 3000);
            }, 600);
        }

        function addMessage(role, text) {
            const history = document.getElementById('chatHistory');
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg ${role}`;
            if(role === 'char') msgDiv.setAttribute('data-sender', charName);
            msgDiv.innerText = text;
            history.appendChild(msgDiv);
            history.scrollTop = history.scrollHeight;
            
            // 记录日志
            const prefix = role === 'char' ? `[${charName}]` : '[ROOKIE]';
            chatLog.push(`${prefix} ${text}`);
        }

        function showOptions(opts) {
            const area = document.getElementById('optionsArea');
            area.innerHTML = "";
            
            opts.forEach(opt => {
                const btn = createBtn(opt.text, () => userSelect(opt.text, opt.next));
                area.appendChild(btn);
            });

            // 强制添加红色紧急按钮
            let emText = "⚠ 请求紧急支援！(EMERGENCY)";
            if(charName.includes("莉卡")) emText = "⚠ 别管车了快救我！(HELP!)";
            if(charName.includes("翠")) emText = "⚠ 申请全功率清除许可！(DANGER)";
            if(charName.includes("葵")) emText = "⚠ 妈妈救命！！(SOS)";

            const emBtn = createBtn(emText, () => userSelect(emText, 99));
            emBtn.classList.add('emergency');
            area.appendChild(emBtn);
        }

        function createBtn(text, onClick) {
            const btn = document.createElement('div');
            btn.className = "option-btn";
            btn.innerText = ">> " + text;
            btn.onclick = onClick;
            return btn;
        }

        function showTypingIndicator() {
            const history = document.getElementById('chatHistory');
            const div = document.createElement('div');
            div.id = "typing";
            div.className = "msg char";
            div.setAttribute('data-sender', charName);
            div.innerText = "...";
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }
        function removeTypingIndicator() { const t = document.getElementById('typing'); if(t) t.remove(); }

        function showDeployScreen() {
            document.getElementById('chatOverlay').style.display = "none";
            const screen = document.getElementById('deployScreen');
            screen.style.display = "flex";
            
            // 更新显示谁在支援
            document.getElementById('deployNameText').innerText = charName.split('·')[1] || charName;
        }

        function copyLog() {
            const textToCopy = chatLog.join('\n');
            navigator.clipboard.writeText(textToCopy).then(() => {
                const hint = document.getElementById('copyHint');
                hint.style.opacity = 1;
                setTimeout(() => hint.style.opacity = 0, 2000);
            });
        }
/* --- 新增逻辑：返回控制 --- */

// 关闭聊天窗口
function closeChat() {
    document.getElementById('chatOverlay').style.display = "none";
    // 可选：清除当前聊天的打字机效果，防止后台报错
    const typer = document.getElementById('typing');
    if(typer) typer.remove();
}

// 重置系统（从结算画面返回）
function resetSystem() {
    document.getElementById('deployScreen').style.display = "none";
    document.getElementById('chatOverlay').style.display = "none";
    
    // 可选：重置为第一个角色或保持当前位置，这里不做额外操作即可回到轮播页
}
    </script>
</body>
</html>
